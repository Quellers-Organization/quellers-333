setup:
  - requires:
      cluster_features: "gte_v8.14.0"
      test_runner_features: [ capabilities, close_to ]
      capabilities:
        - method: GET
          path: /_cluster/stats
          capabilities:
            - "retrievers-usage-stats"
      reason: 'rrf retriever added in 8.14 and we need the retrievers-usage-stats capability for granular retriever telemetry'

  - do:
      indices.create:
        index: test
        body:
          settings:
            number_of_shards: 1
            number_of_replicas: 0
          mappings:
            properties:
              text:
                type: text
              integer:
                type: integer
              vector:
                type: dense_vector
                dims: 1
                index: true

---
"Telemetry for RRF retriever":

  # search#1 - this will record 1 entry for "retriever" in `sections`, and 1 for "knn" under `retrievers`
  - do:
      search:
        index: test
        body:
          {
            "retriever": {
              "knn": {
                "query_vector": [
                  3
                ],
                "field": "vector",
                "k": 10,
                "num_candidates": 15
              }
            }
          }

  # search#2 - this will record 1 entry for "retriever" in `sections`, 1 for "standard" under `retrievers`, and 1 for "range" under `queries`
  - do:
      search:
        index: test
        body:
          {
            "retriever": {
              "standard": {
                "query": {
                  "range": {
                    "integer": {
                      "gte": 2
                    }
                  }
                }
              }
            }
          }

  # search#3 - this will record 1 entry for "retriever" in `sections`, and 1 for "standard" under `retrievers`, and 1 for "knn" under `queries`
  - do:
      search:
        index: test
        body:
          {
            "retriever": {
              "standard": {
                "query": {
                  "knn": {
                    "query_vector": [
                      3
                    ],
                    "field": "vector",
                    "k": 10,
                    "num_candidates": 15
                  }
                }
              }
            }
          }

  # search#4 - this will record 1 entry for "retriever" in `sections`, and 1 for "standard" under `retrievers`, and 1 for "term" under `queries`
  - do:
      search:
        index: test
        body:
          {
            "retriever": {
              "standard": {
                "query": {
                  "term": {
                    "topic": "science"
                  }
                }
              }
            }
          }

  # search#5 - this will record 1 entry for "retriever" in `sections`, and 1 for "rrf" under `retrievers`, as well as
  # 1 for "knn" and 1 for "standard" under `retrievers`, and eventually 1 for "match" under `queries`
  - do:
      search:
        index: test
        body:
          {
            "retriever": {
              "rrf": {
                "retrievers": [
                  {
                    "knn": {
                      "query_vector": [
                        3
                      ],
                      "field": "vector",
                      "k": 10,
                      "num_candidates": 15
                    }
                  },
                  {
                    "standard": {
                      "query": {
                        "match": {
                          "text": "foo"
                        }
                      }
                    }
                  }
                ],
                "rank_window_size": 3,
                "rank_constant": 100
              }
            },
            "track_total_hits": true,
            "size": 3
          }

  # search#6 - this will record 1 entry for "knn" in `sections`
  - do:
      search:
        index: test
        body:
          {
            "knn": {
              "query_vector": [
                3
              ],
              "field": "vector",
              "k": 10,
              "num_candidates": 15
            }
          }

  # search#7 - this will record 1 entry for "query" in `sections`, and 1 for "match_all" under `queries`
  - do:
      search:
        index: test
        body:
          {
            "query": {
              "match_all": { }
            }
          }

  - do: { cluster.stats: { } }

  - match: { indices.search.total: 7 }

  - length: { indices.search.sections: 3 }
  - match: { indices.search.sections.retriever: 5 }
  - match: { indices.search.sections.knn: 1 }
  - match: { indices.search.sections.query: 1 }

  - length: { indices.search.retrievers: 3 }
  - match: { indices.search.retrievers.standard: 4 }
  - match: { indices.search.retrievers.knn: 2 }
  - match: { indices.search.retrievers.rrf: 1 }

  - length: { indices.search.queries: 5 }
  - match: { indices.search.queries.range: 1 }
  - match: { indices.search.queries.knn: 1 }
  - match: { indices.search.queries.term: 1 }
  - match: { indices.search.queries.match: 1 }
  - match: { indices.search.queries.match_all: 1 }
