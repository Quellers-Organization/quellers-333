---
"Source filtering":


  - do:
      index:
        refresh: true
        index: test_index
        id: test_id_1
        body: { "foo": "bar", "bar": "foo" }

  - do:
      index:
        refresh: true
        index: test_index
        id: test_id_2
        body: { "foo": "qux", "bar": "pux" }

  - do:
      index:
        refresh: true
        index: test_index
        id: test_id_3
        body: { "foo": "corge", "bar": "forge" }


  - do:
      bulk:
        refresh: true
        body: |
          { "update": { "_index": "test_index", "_id": "test_id_1", "_source": true } }
          { "doc": { "foo": "baz" } }
          { "update": { "_index": "test_index", "_id": "test_id_2" } }
          { "_source": true, "doc": { "foo": "quux" } }

  - match: { items.0.update.get._source.foo: baz }
  - match: { items.1.update.get._source.foo: quux }

  - do:
      bulk:
        index: test_index
        _source: true
        body: |
          { "update": { "_id": "test_id_3" } }
          { "doc": { "foo": "garply" } }

  - match: { items.0.update.get._source.foo: garply }

  - do:
      bulk:
        refresh: true
        body: |
          { "update": { "_index": "test_index", "_id": "test_id_1", "_source": {"includes": "bar"} } }
          { "doc": { "foo": "baz" } }
          { "update": { "_index": "test_index", "_id": "test_id_2" } }
          { "_source": {"includes": "foo"}, "doc": { "foo": "quux" } }

  - match: { items.0.update.get._source.bar: foo }
  - is_false: items.0.update.get._source.foo
  - match: { items.1.update.get._source.foo: quux }
  - is_false: items.1.update.get._source.bar

  - do:
      bulk:
        index: test_index
        _source_includes: foo
        body: |
          { "update": { "_id": "test_id_3" } }
          { "doc": { "foo": "garply" } }

  - match: { items.0.update.get._source.foo: garply }
  - is_false: items.0.update.get._source.bar

---
"Source filtering includes embeddings by default":
  - requires:
      cluster_features: "search.hide_vectors_in_source"
      reason: vector _source filtering added in 8.16.0

  - do:
      indices.create:
        index: vector-test
        body:
          mappings:
            properties:
              text:
                type: text
              sparse:
                type: sparse_vector
              dense:
                type: dense_vector
                dims: 3

  - do:
      index:
        index: vector-test
        id: 1
        body:
          text: running is good for you
          sparse:
            running: 2.4097164
            good: 2.170997
            run: 2.052153
            race: 0.1
          dense: [ 1.0, 2.0, 3.0 ]
        refresh: true

  - do:
      bulk:
        index: vector-test
        _source: true
        body:
          - '{"update": {"_id": "1"}}'
          - '{"doc":{"text": "running is fun!"}}'

  - length: { items: 1 }
  - match: { items.0.update.get._source.text: "running is fun!" }
  - exists: items.0.update.get._source.sparse
  - exists: items.0.update.get._source.dense

---
"Source filtering includes embeddings":
  - requires:
      cluster_features: "search.hide_vectors_in_source"
      reason: vector _source filtering added in 8.16.0

  - do:
      indices.create:
        index: vector-test
        body:
          mappings:
            properties:
              text:
                type: text
              sparse:
                type: sparse_vector
              dense:
                type: dense_vector
                dims: 3

  - do:
      index:
        index: vector-test
        id: 1
        body:
          text: running is good for you
          sparse:
            running: 2.4097164
            good: 2.170997
            run: 2.052153
            race: 0.1
          dense: [ 1.0, 2.0, 3.0 ]
        refresh: true

  - do:
      bulk:
        index: vector-test
        _source_include_vectors: true
        body:
          - '{"update": {"_id": "1"}}'
          - '{"doc":{"text": "running is fun!"}}'

  - length: { items: 1 }
  - match: { items.0.update.get._source.text: "running is fun!" }
  - exists: items.0.update.get._source.sparse
  - exists: items.0.update.get._source.dense

---
"Source filtering excludes embeddings":
  - requires:
      cluster_features: "search.hide_vectors_in_source"
      reason: vector _source filtering added in 8.16.0

  - do:
      indices.create:
        index: vector-test
        body:
          mappings:
            properties:
              text:
                type: text
              sparse:
                type: sparse_vector
              dense:
                type: dense_vector
                dims: 3

  - do:
      index:
        index: vector-test
        id: 1
        body:
          text: running is good for you
          sparse:
            running: 2.4097164
            good: 2.170997
            run: 2.052153
            race: 0.1
          dense: [ 1.0, 2.0, 3.0 ]
        refresh: true

  - do:
      bulk:
        index: vector-test
        _source_include_vectors: false
        body:
          - '{"update": {"_id": "1"}}'
          - '{"doc":{"text": "running is fun!"}}'

  - length: { items: 1 }
  - match: { items.0.update.get._source.text: "running is fun!" }
  - not_exists: items.0.update.get._source.sparse
  - not_exists: items.0.update.get._source.dense
